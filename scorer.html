<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Resume Scorer</title>
<style>
  /* Cyme Default (fixed) */
  body { margin:0; padding:20px; background:#fafafa; color:#0f1115; font-family:Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial }
  .card,.section { background:#fff; border:1px solid #e9edf2; border-radius:16px; box-shadow:0 4px 14px rgba(15,17,21,.05); padding:16px }
  h3 { margin:0 0 6px; letter-spacing:.2px }
  .muted{ color:#64748b }
  textarea{ width:100%; padding:12px 14px; border:1px solid #e5e7eb; border-radius:12px; background:#fff; color:#0f1115; resize:vertical }
  button{ padding:10px 14px; border:1px solid #e5e7eb; border-radius:12px; background:#0f1115; color:#fff; font-weight:600; cursor:pointer }
  button:hover{ filter:brightness(1.06) }
  button[disabled]{ opacity:.6; cursor:not-allowed }
  .grid{ display:grid; grid-template-columns:1fr; gap:12px; margin-top:12px }
  @media(min-width:900px){ .two{ grid-template-columns:1fr 1fr } }
  .section h4{ margin:0 0 8px; font-size:15px }
  .pill{ display:inline-block; padding:4px 8px; border:1px solid #e5e7eb; border-radius:999px; margin:3px 6px 0 0; font-size:12px }
  .hide{ display:none !important }
  .err{ color:#ef4444; font-weight:600 }
  /* Score ring */
  .ring{ position:relative; width:120px; height:120px }
  .ring svg{ width:100%; height:100%; display:block; transform:rotate(-90deg) }
  .ring .center{ position:absolute; inset:0; display:flex; align-items:center; justify-content:center; font-weight:800; font-size:24px }
  #arc{ stroke:#0ea5e9 }
</style>
</head>
<body>
  <div class="card" style="margin-bottom:16px">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div>
        <h3>Resume Scorer</h3>
        <div class="muted" style="font-size:14px">Paste resume (and optional job) for an instant score.</div>
      </div>
    </div>
    <div class="grid">
      <textarea id="resume" rows="8" placeholder="Paste resume text here…"></textarea>
      <textarea id="job" rows="5" placeholder="(Optional) paste job description here…"></textarea>
    </div>
    <div style="display:flex;align-items:center;gap:12px;margin-top:10px">
      <button id="go">Score Resume</button>
      <span id="status" class="muted"></span>
      <span id="error" class="err hide"></span>
    </div>
  </div>

  <div id="results" class="grid two hide" style="max-width:880px;margin:0 auto">
    <div class="section">
      <div style="display:flex;gap:12px;align-items:center">
        <div class="ring">
          <svg viewBox="0 0 120 120" aria-hidden="true">
            <circle cx="60" cy="60" r="52" fill="none" stroke="#eef2f7" stroke-width="12"/>
            <circle id="arc" cx="60" cy="60" r="52" fill="none" stroke-width="12" stroke-linecap="round" stroke-dasharray="0 999"/>
          </svg>
          <div class="center" id="scoreNum">0</div>
        </div>
        <div>
          <div class="muted" style="font-size:13px">Overall Score</div>
          <div id="overallReason" style="margin-top:6px; font-size:14px; line-height:1.4"></div>
        </div>
      </div>
    </div>

    <div class="section">
      <h4>Quick Summary</h4>
      <div><span class="muted">Completeness:</span> <span id="kvCompleteness">—</span></div>
      <div style="margin-top:4px"><span class="muted">Impact:</span> <span id="kvImpact">—</span></div>
      <div style="margin-top:4px"><span class="muted">Tailored:</span> <span id="kvTailored">—</span></div>
    </div>

    <div class="section">
      <h4>Completeness</h4>
      <div id="completenessBlock">—</div>
    </div>

    <div class="section">
      <h4>Impact</h4>
      <div id="impactBlock">—</div>
    </div>

    <div class="section hide" id="jobAlignSection">
      <h4>Job Alignment</h4>
      <div id="jobAlignBlock">—</div>
    </div>

    <div class="section">
      <h4>Overall Improvements</h4>
      <ul id="improvementsList" style="margin:8px 0 0 18px"></ul>
    </div>

    <div class="section">
      <h4>Miscellaneous Metrics</h4>
      <div id="miscBlock">—</div>
    </div>
  </div>

<script>
const API = location.origin;
const $ = (id) => document.getElementById(id);
const postResize = () => parent.postMessage({ source:'cyme-scorer', type:'resize', height: document.body.scrollHeight }, '*');
new ResizeObserver(postResize).observe(document.body);
window.addEventListener('load', postResize);

function setError(msg){ $('error').classList.remove('hide'); $('error').textContent = msg; }
function clearError(){ $('error').classList.add('hide'); $('error').textContent = ''; }
function busy(b){ $('go').disabled = b; $('status').textContent = b ? ' Scoring…' : ''; }

function setRing(score){
  const n = Math.max(0, Math.min(100, Number(score||0)));
  const r=52, C=2*Math.PI*r, filled=(n/100)*C;
  $('arc').setAttribute('stroke-dasharray', `${filled} ${C}`);
  $('scoreNum').textContent = n;
}
function renderKV(targetId, obj){
  const el=$(targetId);
  if(!obj||typeof obj!=='object'){ el.textContent='—'; return; }
  const val=('score' in obj)?obj.score:(obj.value??'—');
  const reason=obj.reason?` — ${obj.reason}`:'';
  el.textContent = `${val}${reason}`;
}
function renderList(ulId, arr){
  const ul=$(ulId); ul.innerHTML='';
  if(!Array.isArray(arr)||!arr.length){ ul.innerHTML='<li class="muted">No items.</li>'; return; }
  for(const item of arr){
    const li=document.createElement('li'); li.style.margin='4px 0';
    li.textContent=(typeof item==='string')?item:(item?.text||JSON.stringify(item));
    ul.appendChild(li);
  }
}
function renderBullets(containerId, obj){
  const c=$(containerId); c.innerHTML='';
  if(!obj||typeof obj!=='object'){ c.textContent='—'; return; }
  for(const [k,v] of Object.entries(obj)){
    const line=document.createElement('div'); line.style.margin='4px 0';
    const name=document.createElement('span'); name.className='pill'; name.textContent=k;
    const desc=document.createElement('span'); desc.className='muted';
    const score=(v&&typeof v==='object'&&'score'in v)?` (${v.score})`:'';
    const reason=(v&&typeof v==='object'&&v.reason)?` — ${v.reason}`:'';
    desc.textContent=score+reason; line.appendChild(name); line.appendChild(desc); c.appendChild(line);
  }
}
function renderJobAlignment(targetId, ja){
  const c=$(targetId); c.innerHTML='';
  if(!ja||typeof ja!=='object'){ c.textContent='—'; return; }
  const blocks=[['KEYWORD MATCH', ja.keywordMatch||ja.KEYWORD_MATCH],
                ['SKILLS MATCH', ja.skillsMatch||ja.SKILLS_MATCH],
                ['EXPERIENCE RELEVANCE', ja.experienceRelevance||ja.EXPERIENCE_RELEVANCE],
                ['COMPANY FIT', ja.companyFit||ja.COMPANY_FIT]];
  for(const [title,data] of blocks){
    const box=document.createElement('div'); box.style.margin='8px 0';
    const h=document.createElement('div'); h.style.fontWeight='700'; h.style.fontSize='14px'; h.textContent=title;
    const p=document.createElement('div'); p.className='muted'; p.style.marginTop='4px';
    p.textContent=typeof data==='string'?data:JSON.stringify(data,null,2);
    box.appendChild(h); box.appendChild(p); c.appendChild(box);
  }
}

$('go').addEventListener('click', async () => {
  clearError();
  const resumeText=$('resume').value.trim();
  const jobText=$('job').value.trim();
  if(!resumeText){ setError('Please paste your resume.'); return; }

  busy(true); $('results').classList.add('hide');
  try{
    const body={ resume:{ raw_text:resumeText, is_base_resume:!jobText }, job: jobText?{ description:jobText }:null };
    const res=await fetch(`${API}/api/public/resume-score`, {
      method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)
    });
    const data=await res.json(); if(!res.ok) throw new Error(data?.error||'Failed to score');

    setRing(data?.overallScore?.score ?? 0);
    $('overallReason').textContent = data?.overallScore?.reason || '';
    renderKV('kvCompleteness', data?.completeness);
    renderKV('kvImpact', data?.impactScore);
    $('kvTailored').textContent = data?.isTailoredResume ? 'Yes' : 'No';
    renderBullets('completenessBlock', data?.completeness);
    renderBullets('impactBlock', data?.impactScore);
    renderList('improvementsList', data?.overallImprovements);
    renderBullets('miscBlock', data?.miscellaneous);

    if(data?.jobAlignment){
      $('jobAlignSection').classList.remove('hide');
      renderJobAlignment('jobAlignBlock', data.jobAlignment);
    } else {
      $('jobAlignSection').classList.add('hide');
      $('jobAlignBlock').textContent='—';
    }

    $('results').classList.remove('hide');
    $('status').textContent='';
  } catch(e){ setError(e?.message||'Error'); }
  finally { busy(false); postResize(); }
});
</script>
</body>
</html>
